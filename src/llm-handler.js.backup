/**
 * Ollama LLM integration for document content generation.
 */

import { config } from "./config.js";
import { TaskType } from "./models.js";
import { getTeamDescriptionText } from "./team-descriptions.js";
import { getAgentByTaskType } from "./agents.js";

/**
 * Build prompt using agent configuration
 * @param {object} agent - Agent configuration
 * @param {object} employee - Employee data
 * @param {string} additionalInfo - Additional information from coordinator
 * @param {string} teamDescription - Team description text
 * @param {object} options - Additional options (genderNote, tenseNote, etc.)
 * @returns {string} - Complete prompt
 */
function buildAgentPrompt(agent, employee, additionalInfo, teamDescription, options = {}) {
  const { genderNote = '', tenseNote = '', roleFocus = '', outputFormat = '' } = options;

  let prompt = `${agent.personality}

Wolontariusz/Praktykant: ${employee.name} ${employee.surname}
Status: ${employee.status || 'nieznany'}
${genderNote}
${tenseNote}

Informacje z bazy danych Excel:
- Zespół: ${employee.team}
- Okres współpracy: od ${employee.startDate} do ${employee.endDate}
- Główne zadania: ${employee.mainTasks}

${teamDescription}

Dodatkowe informacje od koordynatora:
${additionalInfo}

ZASADY I WYTYCZNE:
${agent.guidelines.map((g, i) => `${i + 1}. ${g}`).join('\n')}

${agent.structureTemplate}

${outputFormat}

WZORCOWE PRZYKŁADY:
`;

  // Add examples from agent
  agent.examples.forEach((example, index) => {
    prompt += `\n--- PRZYKŁAD ${index + 1}: ${example.description} ---\n`;
    if (typeof example.output === 'string') {
      prompt += `${example.output}\n`;
    } else {
      prompt += `${JSON.stringify(example.output, null, 2)}\n`;
    }
  });

  prompt += `\n\nTERAZ WYGENERUJ ODPOWIEDŹ dla:
Osoba: ${employee.name} ${employee.surname}
Zespół: ${employee.team}
Dodatkowe informacje: ${additionalInfo}

${outputFormat ? 'Pamiętaj o zwróceniu odpowiedzi w poprawnym formacie JSON.' : ''}`;

  return prompt;
}

/**
 * Generate text using Ollama LLM
 * @param {string} prompt - The prompt to send
 * @returns {Promise<string>} - Generated text
 */
async function generate(prompt) {
  try {
    console.log("[OLLAMA] Connecting to Ollama...");
    console.log(`[OLLAMA] URL: ${config.ollamaBaseUrl}`);
    console.log(`[OLLAMA] Model: ${config.ollamaModel}`);
    console.log(`[OLLAMA] Prompt length: ${prompt.length} characters`);
    console.log(`[OLLAMA] Prompt preview: ${prompt.substring(0, 200)}...`);

    // Add timeout to fetch request (300 seconds for long prompts with team descriptions and examples)
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 300000);

    console.log("[OLLAMA] Sending request (timeout: 300s)...");
    const startTime = Date.now();
    const request_obj = {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        model: config.ollamaModel,
        prompt,
        stream: false,
        // Removed format: "json" - it causes Ollama to hang on long prompts
      }),
      signal: controller.signal,
    };

    const response = await fetch(
      `${config.ollamaBaseUrl}/api/generate`,
      request_obj
    );

    clearTimeout(timeoutId);
    const duration = ((Date.now() - startTime) / 1000).toFixed(2);
    console.log(`[OLLAMA] Response received in ${duration}s`);

    if (!response.ok) {
      const errorText = await response.text();
      console.log("[OLLAMA] ✗ Request failed");
      console.log(`[OLLAMA] Status: ${response.status} ${response.statusText}`);
      console.log(`[OLLAMA] Error response: ${errorText}`);
      throw new Error(
        `Ollama request failed: ${response.status} ${response.statusText}`
      );
    }

    const result = await response.json();
    console.log("[OLLAMA] ✓ Request successful");
    console.log(
      `[OLLAMA] Response length: ${result.response ? result.response.length : 0} characters`
    );
    console.log(`[OLLAMA] Raw response: ${result.response}`);

    return result.response || "";
  } catch (error) {
    if (error.name === "AbortError") {
      console.log("[OLLAMA] ✗ Request timed out after 300 seconds");
      throw new Error("Ollama request timed out");
    }
    console.log(`[OLLAMA] ✗ Request failed: ${error.message}`);
    throw error;
  }
}

/**
 * Generate references document content
 * @param {object} employee - Employee data
 * @param {string} additionalInfo - Additional information
 * @returns {Promise<object>} - Generated content
 */
export async function generateReferences(employee, additionalInfo) {
  console.log("[LLM-REF] Generating references document...");
  console.log(`[LLM-REF] Employee: ${employee.name} ${employee.surname}`);
  console.log(`[LLM-REF] Gender: ${employee.gender || 'unknown'}`);
  console.log(`[LLM-REF] Team: ${employee.team}`);
  console.log(
    `[LLM-REF] Additional info: ${additionalInfo ? additionalInfo.substring(0, 100) + "..." : "(none)"}`
  );

  // Determine if employee is active
  const isActive = employee.status && employee.status.toLowerCase().includes('aktywny') && !employee.status.toLowerCase().includes('nieaktywny');

  // Determine gender-specific instructions with tense consideration
  const genderNote = employee.gender === 'K'
    ? `WAŻNE: Ta osoba jest KOBIETĄ - używaj form żeńskich ${isActive ? '(np. "wykazuje się", "współpracuje", "angażuje się")' : '(np. "wykazała się", "współpracowała", "angażowała się")'}.`
    : employee.gender === 'M'
    ? `WAŻNE: Ta osoba jest MĘŻCZYZNĄ - używaj form męskich ${isActive ? '(np. "wykazuje się", "współpracuje", "angażuje się")' : '(np. "wykazał się", "współpracował", "angażował się")'}.`
    : 'Dostosuj formy gramatyczne do płci na podstawie imienia.';

  const tenseNote = isActive
    ? 'UWAGA: Status tej osoby to AKTYWNY - używaj form TERAŹNIEJSZYCH czasowników (np. "jest odpowiedzialna", "tworzy", "uczestniczy", "pracuje").'
    : 'UWAGA: Status tej osoby to NIEAKTYWNY - używaj form PRZESZŁYCH czasowników (np. "była odpowiedzialna", "tworzyła", "uczestniczyła", "pracowała").';

  // Get team description if available
  const teamDescription = getTeamDescriptionText(employee.team);

  const prompt = `Jesteś profesjonalnym, skrupulatnym i obiektywnym koordynatorem wolontariatu w organizacji pozarządowej LEVEL UP, specjalizującym się w komunikacji HR. Tworzysz szczegółowe, profesjonalne referencje dla wolontariuszy i praktykantów.

Wolontariusz/Praktykant: ${employee.name} ${employee.surname}
Status: ${employee.status || 'nieznany'}
${genderNote}
${tenseNote}

Informacje z bazy danych Excel:
- Zespół: ${employee.team}
- Okres współpracy: od ${employee.startDate} do ${employee.endDate}
- Główne zadania: ${employee.mainTasks}

${teamDescription}

Dodatkowe informacje od koordynatora:
${additionalInfo}

INSTRUKCJE:
Na podstawie WSZYSTKICH powyższych informacji (z bazy danych Excel, opisu zespołu i dodatkowych od koordynatora), napisz profesjonalny, szczegółowy tekst referencji składający się z 3-4 akapitów.

WAŻNE: Wykorzystuj informacje o głównych działaniach zespołu do opisywania konkretnych zadań realizowanych przez osobę. Jeśli dodatkowe informacje od koordynatora nie podają szczegółów, bazuj na typowych działaniach zespołu.

STRUKTURA REFERENCJI (bez nagłówków - każdy akapit jako osobny blok tekstu):

AKAPIT 1 - Zakres odpowiedzialności i pełnione funkcje:
Rozpocznij od "W czasie współpracy Pani/Pan [imię]..." (NIE podawaj nazwiska, NIE powtarzaj dat ani zespołu - są już w nagłówku). Opisz główne obszary odpowiedzialności, pełnione funkcje i kluczowe zadania. Jeśli osoba pełniła specjalne funkcje (np. koordynatorka), wymień je. Bądź konkretny i szczegółowy (np. "była odpowiedzialna za współtworzenie i wdrażanie strategii marketingowej organizacji, obejmującej planowanie komunikacji w mediach społecznościowych, założenie oraz rozwój kanału na platformie TikTok oraz budowanie spójnego wizerunku LEVEL UP w kanałach online").

AKAPIT 2 - Cechy charakteru i sposób pracy:
Opisz cechy osobowościowe i sposób pracy osoby w kontekście realizowanych zadań. Wymień konkretne cechy (np. "Wykazywała się bardzo dużą aktywnością, samodzielnością oraz kreatywnością, regularnie inicjując nowe działania i usprawnienia w obszarze marketingu cyfrowego").

AKAPIT 3 - Dodatkowe obszary działalności i osiągnięcia:
Jeśli osoba była zaangażowana w dodatkowe obszary (np. projekty międzynarodowe, reprezentowanie organizacji), opisz je szczegółowo z konkretnymi przykładami. Wyróżnij specjalne osiągnięcia i wpływ na organizację (np. "aktywnie uczestniczyła również w projektach międzynarodowych, w ramach których reprezentowała Stowarzyszenie LEVEL UP za granicą. Dała się poznać jako osoba odpowiedzialna, komunikatywna i profesjonalna").

AKAPIT 4 - Ocena końcowa i rekomendacja:
Rozpocznij od "Przez cały okres współpracy, Pani/Pan [imię]...". Oceń jakość pracy i wyróżniające się umiejętności (np. "pracowała rzetelnie i konsekwentnie, wywiązując się z powierzonych zadań na bardzo wysokim poziomie. Wyróżniała się umiejętnością strategicznego myślenia, efektywnej koordynacji działań oraz pracy zespołowej"). Podkreśl wkład osoby w rozwój organizacji. Zakończ ZAWSZE jednoznaczną rekomendacją: "Stowarzyszenie LEVEL UP z pełnym przekonaniem rekomenduje współpracę z Panią/Panem [imię] [nazwisko]."

WAŻNE ZASADY:
Jesteś skoncentrowany na jakości i zgodności informacji.
- Używaj formy grzecznościowej "Pan/Pani" + imię przy pierwszym wskazaniu w każdym akapicie (np. "Pani Kinga", nie "Pani Kinga Maziarz")
- W ostatnim zdaniu rekomendacji używaj pełnego imienia i nazwiska: "Stowarzyszenie LEVEL UP z pełnym przekonaniem rekomenduje współpracę z Panią/Panem [imię] [nazwisko]."
- NIE powtarzaj dat ani pełnej nazwy zespołu w treści akapitów - te informacje są już w nagłówku dokumentu
- NIE wymyślaj informacji - używaj TYLKO tego, co zostało podane w dodatkowych informacjach i bazie danych
- Pisz w trzeciej osobie
- Bądź konkretny, szczegółowy i profesjonalny - używaj konkretnych przykładów i faktów
- Akapit 1: 2-3 zdania o odpowiedzialności i funkcjach
- Akapit 2: 1-2 zdania o cechach charakteru
- Akapit 3: 2-3 zdania o dodatkowych obszarach i osiągnięciach
- Akapit 4: 3-4 zdania oceny + rekomendacja
- Całość powinna mieć 10-14 zdań
- OBOWIĄZKOWO dostosuj wszystkie formy gramatyczne czasowników i przymiotników do płci osoby
- UPEWNIJ SIĘ, że tekst jest w języku polskim i jest poprawny pod względem gramatycznym oraz ortograficznym
- Sprawdź poprawność odmiany przez przypadki, liczby i rodzaje
- Używaj poprawnej polskiej interpunkcji i znaków diakrytycznych (ą, ć, ę, ł, ń, ó, ś, ź, ż)
- Jeśli współpraca zakończyła się negatywnie (brak aktywności, brak kontaktu) - napisz to profesjonalnie w ostatnim akapicie zamiast rekomendacji

BARDZO WAŻNE - FORMAT ODPOWIEDZI:
Zwróć TYLKO i WYŁĄCZNIE poprawny JSON w formacie:
{"referenceText": "Akapit 1.\n\nAkapit 2.\n\nAkapit 3 (opcjonalny).\n\nAkapit końcowy z rekomendacją."}

Użyj \\n\\n aby oddzielić akapity (podwójny znak nowej linii).

WZORCOWY PRZYKŁAD 1 - dla wysoko zaangażowanej wolontariuszki (4 akapity - z projektami międzynarodowymi):
{"referenceText": "W czasie współpracy Pani Kinga była odpowiedzialna za współtworzenie i wdrażanie strategii marketingowej organizacji, obejmującej planowanie komunikacji w mediach społecznościowych, założenie oraz rozwój kanału na platformie TikTok oraz budowanie spójnego wizerunku LEVEL UP w kanałach online. Pełniła również funkcję koordynatorki TikToka oraz koordynowała czasowo działania na innych kanałach Stowarzyszenia w mediach społecznościowych, odgrywając kluczową rolę w rozwoju komunikacji marketingowej.\n\nWykazywała się bardzo dużą aktywnością, samodzielnością oraz kreatywnością, regularnie inicjując nowe działania i usprawnienia w obszarze marketingu cyfrowego.\n\nPani Kinga aktywnie uczestniczyła również w projektach międzynarodowych, w ramach których reprezentowała Stowarzyszenie LEVEL UP za granicą. W trakcie tych działań dała się poznać jako osoba odpowiedzialna, komunikatywna i profesjonalna, bardzo dobrze prezentująca organizację w środowisku międzynarodowym. Jej zaangażowanie oraz umiejętność pracy w wielokulturowych zespołach miały istotne znaczenie dla budowania relacji partnerskich oraz wizerunku LEVEL UP.\n\nPrzez cały okres współpracy, Pani Kinga pracowała rzetelnie i konsekwentnie, wywiązując się z powierzonych zadań na bardzo wysokim poziomie. Wyróżniała się umiejętnością strategicznego myślenia, efektywnej koordynacji działań oraz pracy zespołowej. Jej wkład znacząco przyczynił się do rozwoju działań marketingowych oraz rozpoznawalności Stowarzyszenia LEVEL UP. Stowarzyszenie LEVEL UP z pełnym przekonaniem rekomenduje współpracę z Panią Kingą Maziarz."}

WZORCOWY PRZYKŁAD 2 - dla wysoko zaangażowanej wolontariuszki (3 akapity - rekrutacja i marketing):
{"referenceText": "W czasie współpracy Pani Kinga była odpowiedzialna za przygotowanie i planowanie procesów rekrutacyjnych do zespołów, w tym opracowywanie scenariuszy rozmów rekrutacyjnych, publikowanie ogłoszeń rekrutacyjnych oraz bieżąca komunikacja z kandydatami. Tworzyła także materiały informacyjne i wdrożeniowe dla wolontariuszy, wspierające onboarding oraz dalszą współpracę w zespołach.\n\nW ramach działań marketingowych wolontariuszka odpowiadała za publikację ogłoszeń, komunikatów i treści w mediach społecznościowych, dbając o ich spójność z wizerunkiem Stowarzyszenia LEVEL UP.\n\nPrzez cały okres współpracy, Pani Kinga pracowała rzetelnie i konsekwentnie, wywiązując się z powierzonych zadań na bardzo wysokim poziomie. Wyróżniała się umiejętnością strategicznego myślenia, efektywnej koordynacji działań oraz pracy zespołowej. Jej wkład znacząco przyczynił się do rozwoju działań marketingowych oraz rozpoznawalności Stowarzyszenia LEVEL UP.\n\nStowarzyszenie LEVEL UP z pełnym przekonaniem rekomenduje współpracę z Panią Kingą Kowalską."}`;

  try {
    console.log("[LLM-REF] Calling Ollama API...");
    let response = await generate(prompt);

    console.log("[LLM-REF] Parsing JSON response...");

    // Clean up the response - extract only the first valid JSON object
    let cleanedResponse = response.trim();

    // Find the start of the first JSON object
    const startIdx = cleanedResponse.indexOf('{');
    if (startIdx === -1) {
      throw new Error('No JSON object found in response');
    }

    // Use brace counting to find the matching closing brace for the FIRST object only
    let depth = 0;
    let inString = false;
    let escaped = false;
    let endIdx = -1;

    for (let i = startIdx; i < cleanedResponse.length; i++) {
      const char = cleanedResponse[i];

      // Handle escape sequences
      if (escaped) {
        escaped = false;
        continue;
      }

      if (char === '\\') {
        escaped = true;
        continue;
      }

      // Track string boundaries (don't count braces inside strings)
      if (char === '"') {
        inString = !inString;
      }

      // Count braces only outside of strings
      if (!inString) {
        if (char === '{') {
          depth++;
        } else if (char === '}') {
          depth--;
          // When we return to depth 0, we've found the end of the first object
          if (depth === 0) {
            endIdx = i + 1;
            break;
          }
        }
      }
    }

    if (endIdx === -1) {
      console.log("[LLM-REF] WARNING: Could not find matching closing brace");
      throw new Error('Incomplete JSON object in response');
    }

    // Extract only the first complete JSON object
    cleanedResponse = cleanedResponse.substring(startIdx, endIdx);
    console.log("[LLM-REF] Extracted first JSON object");
    console.log(`[LLM-REF] Length: ${cleanedResponse.length} chars`);

    // Remove trailing comma before closing brace (LLM sometimes adds it)
    cleanedResponse = cleanedResponse.replace(/,(\s*})$/, '$1');

    const parsed = JSON.parse(cleanedResponse);

    console.log(
      `[LLM-REF] ✓ Parsed successfully, referenceText length: ${parsed.referenceText ? parsed.referenceText.length : 0}`
    );

    const result = {
      name: employee.name,
      surname: employee.surname,
      startDate: employee.startDate,
      endDate: employee.endDate,
      team: employee.team,
      mainTasks: employee.mainTasks,
      referenceText: parsed.referenceText || "",
    };

    if (!result.referenceText || result.referenceText.trim() === "") {
      console.log("[LLM-REF] WARNING: referenceText is empty!");
    } else {
      console.log(
        `[LLM-REF] referenceText preview: ${result.referenceText.substring(0, 100)}...`
      );
    }

    return result;
  } catch (error) {
    console.log("[LLM-REF] ✗ Generation failed, using defaults");
    console.log(`[LLM-REF] Error: ${error.message}`);

    return {
      name: employee.name,
      surname: employee.surname,
      startDate: employee.startDate,
      endDate: employee.endDate,
      team: employee.team,
      mainTasks: employee.mainTasks,
      referenceText: "",
    };
  }
}

/**
 * Generate certificate content - adds 2 professional sentences based on additional info
 * @param {object} employee - Employee data
 * @param {string} additionalInfo - Additional information
 * @returns {Promise<object>} - Generated content
 */
export async function generateCert(employee, additionalInfo) {
  console.log("[LLM-CERT] Generating certificate document...");
  console.log(`[LLM-CERT] Employee: ${employee.name} ${employee.surname}`);
  console.log(`[LLM-CERT] Gender: ${employee.gender || 'unknown'}`);
  console.log(`[LLM-CERT] Team: ${employee.team}`);
  console.log(
    `[LLM-CERT] Additional info: ${additionalInfo ? additionalInfo.substring(0, 100) + "..." : "(none)"}`
  );

  // Determine if employee is active
  const isActive = employee.status && employee.status.toLowerCase().includes('aktywny') && !employee.status.toLowerCase().includes('nieaktywny');

  // Determine gender-specific instructions with tense consideration
  const genderNote = employee.gender === 'K'
    ? `WAŻNE: Ta osoba jest KOBIETĄ - używaj form żeńskich ${isActive ? '(np. "wykazuje się", "przyczynia się", "odnosi sukces")' : '(np. "wykazała się", "przyczyniła się", "odniosła sukces")'}.`
    : employee.gender === 'M'
    ? `WAŻNE: Ta osoba jest MĘŻCZYZNĄ - używaj form męskich ${isActive ? '(np. "wykazuje się", "przyczynia się", "odnosi sukces")' : '(np. "wykazał się", "przyczynił się", "odniósł sukces")'}.`
    : 'Dostosuj formy gramatyczne do płci na podstawie imienia.';

  const tenseNote = isActive
    ? 'UWAGA: Status tej osoby to AKTYWNY - używaj form TERAŹNIEJSZYCH czasowników (np. "pomaga", "tworzy", "uczestniczy", "wykazuje się", "angażuje się").'
    : 'UWAGA: Status tej osoby to NIEAKTYWNY - używaj form PRZESZŁYCH czasowników (np. "pomagała", "tworzyła", "uczestniczyła", "wykazała się", "angażowała się").';

  // Determine role-specific focus
  const roleLower = (employee.role || '').toLowerCase();
  let roleFocus = '';
  if (roleLower.includes('praktyk') || roleLower.includes('staz')) {
    roleFocus = isActive
      ? 'W przypadku praktykantów/stażystów skup się na działaniach i tym, jak realizują zadania (formy teraźniejsze).'
      : 'W przypadku praktykantów/stażystów skup się na działaniach i tym, jak realizowali zadania (formy przeszłe).';
  } else if (roleLower.includes('wolontari')) {
    roleFocus = isActive
      ? 'W przypadku wolontariuszy skup się na ich wpływie na zespół, tym jak działają oraz jakie działania są ich głównymi (formy teraźniejsze).'
      : 'W przypadku wolontariuszy skup się na ich wpływie na zespół, tym jak działali oraz jakie działania były ich głównymi (formy przeszłe).';
  } else {
    roleFocus = isActive
      ? 'Skup się na osiągnięciach i zaangażowaniu osoby (formy teraźniejsze).'
      : 'Skup się na osiągnięciach i zaangażowaniu osoby (formy przeszłe).';
  }

  // Get team description if available
  const teamDescription = getTeamDescriptionText(employee.team);

  const prompt = `Jesteś profesjonalnym, skrupulatnym i obiektywnym koordynatorem wolontariatu specjalizującym się w komunikacji HR. Twoją rolą jest analizowanie treści i informacji w celu stworzenia zaświadczenia opisującego współpracę z wolontariuszem bądź praktykantem lub stażystą.
Bądź rzeczowy, wyrażaj się jasno, raczej w pozytywny sposób.
NIE wymyślaj informacji, które są nieprawdziwe.

Osoba: ${employee.name} ${employee.surname}
Rola: ${employee.role || 'wolontariusz'}
Status: ${employee.status || 'nieznany'}
${genderNote}
${tenseNote}

Informacje z bazy danych:
- Zespół: ${employee.team}
- Główne zadania: ${employee.mainTasks}

${teamDescription}

Dodatkowe informacje od koordynatora:
${additionalInfo}

INSTRUKCJE:
Na podstawie podanych dodatkowych informacji sformułuj 2-3 zdania dotyczące współpracy z daną osobą.

${roleFocus}

STRUKTURA OPISU DLA WOLONTARIUSZY:
1. Pierwsze zdanie: konkretne zadania i obszary działania (np. "Pomagała w tworzeniu wielu wniosków projektowych jako główna autorka lub współautorka oraz zawierania partnerstw w projektach lokalnych jak i międzynarodowych.")
2. Drugie zdanie: zaangażowanie i aktywność (np. "Brała czynny udział w spotkaniach grupy roboczej oraz szkoleniach wewnętrznych, wzięła udział w procesie onboardingowym przygotowującym do pracy w zespole rozproszonym.")
3. Opcjonalnie trzecie zdanie: dodatkowe osiągnięcia lub szczególne cechy (jeśli są w dodatkowych informacjach)

Używaj formy grzecznościowej "Pan/Pani" + imię i nazwisko przy pierwszym wskazaniu osoby w tekście.

W przypadku podanych informacji o braku kooperacji lub nagłego zakończenia współpracy, stwórz zdania, które będą miłe, ale wskazywać na to, że nie została dokończona współpraca ze względu na wolontariusza/praktykanta.

WAŻNE ZASADY:
Jesteś skoncentrowany na jakości i zgodności informacji.
- Używaj formy grzecznościowej "Pan/Pani" + imię przy pierwszym wskazaniu
- NIE powtarzaj nazwy zespołu ani dat - te informacje są już w dokumencie
- NIE zmieniaj ani nie dodawaj informacji - używaj TYLKO tego, co zostało podane
- Pisz w trzeciej osobie
- Wyrażaj się rzeczowo, konkretnie i szczegółowo
- Zwróć 2-3 zdania w JEDNYM ciągu tekstowym oddzielone kropkami i spacjami
- OBOWIĄZKOWO dostosuj formy gramatyczne czasowników i przymiotników do płci osoby
- UPEWNIJ SIĘ, że tekst jest w języku polskim i jest poprawny pod względem gramatycznym oraz ortograficznym
- Sprawdź poprawność odmiany przez przypadki, liczby i rodzaje
- Używaj poprawnej polskiej interpunkcji i znaków diakrytycznych (ą, ć, ę, ł, ń, ó, ś, ź, ż)

BARDZO WAŻNE - FORMAT ODPOWIEDZI:
Zwróć TYLKO i WYŁĄCZNIE poprawny JSON w dokładnie takim formacie (bez żadnych dodatkowych pól):
{"additionalDescription": "Pierwsze zdanie o zadaniach. Drugie zdanie o zaangażowaniu. Trzecie zdanie opcjonalne."}

PRZYKŁADY POPRAWNYCH ODPOWIEDZI:

Dla wolontariuszki (średnie zaangażowanie - WZORCOWY PRZYKŁAD):
{"additionalDescription": "Pani Monika pomagała w tworzeniu wielu wniosków projektowych (jako główna autorka lub współautorka) oraz zawierania partnerstw w projektach lokalnych jak i międzynarodowych. Brała czynny udział w spotkaniach grupy roboczej oraz szkoleniach wewnętrznych, wzięła udział w procesie onboardingowym przygotowującym do pracy w zespole rozproszonym."}

Dla wolontariusza (wysokie zaangażowanie):
{"additionalDescription": "Pan Jan aktywnie wspierał zespół w realizacji kampanii marketingowych, tworząc treści do social mediów oraz prowadząc analizy zasięgów. Wykazał się dużym zaangażowaniem i inicjatywą, regularnie uczestnicząc w spotkaniach zespołu oraz proponując innowacyjne rozwiązania. Jego działania przyczyniły się do wzrostu zaangażowania społeczności o 40%."}

Dla praktykantki (pozytywna współpraca):
{"additionalDescription": "Pani Anna efektywnie realizowała powierzone zadania analityczne, przygotowując szczegółowe raporty i zestawienia danych. Wykazała się samodzielnością i dokładnością w pracy, terminowo wykonując wszystkie zlecone zadania."}

Dla wolontariuszki (zakończona współpraca z powodu braku aktywności):
{"additionalDescription": "Pani Maria rozpoczęła współpracę z dużym entuzjazmem, jednak z czasem jej zaangażowanie osłabło. Współpraca została zakończona z inicjatywy wolontariuszki."}

Dla wolontariuszki (nieukończony onboarding, brak kontaktu - WZORCOWY PRZYKŁAD):
{"additionalDescription": "Pani Lena nie ukończyła procesu onboardingowego i współpraca została zakończona ze względu na brak kontaktu z wolontariuszem."}

Dla praktykantki (brak zaangażowania, nieukończony onboarding - WZORCOWY PRZYKŁAD):
{"additionalDescription": "Pani Anna nie ukończyła procesu onboardingowego, nie zrealizowała zadań założonych w planie praktyk a współpraca została zakończona na prośbę ze strony praktykanta."}

Dla praktykanta (brak kooperacji):
{"additionalDescription": "Pan Tomasz wykazywał trudności w komunikacji z zespołem. Mimo wsparcia ze strony koordynatora, praktyka została przerwana przed planowanym terminem."}

TERAZ WYGENERUJ ODPOWIEDŹ DLA:
Osoba: ${employee.name} ${employee.surname}
Dodatkowe informacje: ${additionalInfo}

Odpowiedź (TYLKO JSON, zaczynając od { i kończąc na }):`;


  try {
    console.log("[LLM-CERT] Calling Ollama API...");
    let response = await generate(prompt);

    console.log("[LLM-CERT] Parsing JSON response...");

    // Clean up the response - extract only the first valid JSON object
    let cleanedResponse = response.trim();

    // Find the start of the first JSON object
    const startIdx = cleanedResponse.indexOf('{');
    if (startIdx === -1) {
      throw new Error('No JSON object found in response');
    }

    // Use brace counting to find the matching closing brace for the FIRST object only
    let depth = 0;
    let inString = false;
    let escaped = false;
    let endIdx = -1;

    for (let i = startIdx; i < cleanedResponse.length; i++) {
      const char = cleanedResponse[i];

      // Handle escape sequences
      if (escaped) {
        escaped = false;
        continue;
      }

      if (char === '\\') {
        escaped = true;
        continue;
      }

      // Track string boundaries (don't count braces inside strings)
      if (char === '"') {
        inString = !inString;
      }

      // Count braces only outside of strings
      if (!inString) {
        if (char === '{') {
          depth++;
        } else if (char === '}') {
          depth--;
          // When we return to depth 0, we've found the end of the first object
          if (depth === 0) {
            endIdx = i + 1;
            break;
          }
        }
      }
    }

    if (endIdx === -1) {
      console.log("[LLM-CERT] WARNING: Could not find matching closing brace");
      throw new Error('Incomplete JSON object in response');
    }

    // Extract only the first complete JSON object
    cleanedResponse = cleanedResponse.substring(startIdx, endIdx);
    console.log("[LLM-CERT] Extracted first JSON object");
    console.log(`[LLM-CERT] Length: ${cleanedResponse.length} chars`);
    console.log(`[LLM-CERT] Preview: ${cleanedResponse.substring(0, 100)}...`);

    // Remove trailing comma before closing brace (LLM sometimes adds it)
    cleanedResponse = cleanedResponse.replace(/,(\s*})$/, '$1');

    console.log("[LLM-CERT] About to parse:", cleanedResponse.substring(0, 200));
    const parsed = JSON.parse(cleanedResponse);

    console.log(
      `[LLM-CERT] ✓ Parsed successfully, additionalDescription length: ${parsed.additionalDescription ? parsed.additionalDescription.length : 0}`
    );

    const result = {
      name: employee.name,
      surname: employee.surname,
      startDate: employee.startDate,
      endDate: employee.endDate,
      team: employee.team,
      mainTasks: employee.mainTasks,
      additionalDescription: parsed.additionalDescription || "",
    };

    if (
      !result.additionalDescription ||
      result.additionalDescription.trim() === ""
    ) {
      console.log("[LLM-CERT] WARNING: additionalDescription is empty!");
    } else {
      console.log(
        `[LLM-CERT] additionalDescription: ${result.additionalDescription}`
      );
    }

    return result;
  } catch (error) {
    console.log("[LLM-CERT] ✗ Generation failed, using defaults");
    console.log(`[LLM-CERT] Error: ${error.message}`);

    return {
      name: employee.name,
      surname: employee.surname,
      startDate: employee.startDate,
      endDate: employee.endDate,
      team: employee.team,
      mainTasks: employee.mainTasks,
      additionalDescription: "",
    };
  }
}

/**
 * Generate internship document content
 * @param {object} employee - Employee data
 * @param {string} additionalInfo - Additional information
 * @returns {Promise<object>} - Generated content
 */
export async function generateInternship(employee, additionalInfo) {
  console.log("[LLM-INT] Generating internship document...");
  console.log(`[LLM-INT] Employee: ${employee.name} ${employee.surname}`);
  console.log(`[LLM-INT] Gender: ${employee.gender || 'unknown'}`);
  console.log(`[LLM-INT] Team: ${employee.team}`);
  console.log(
    `[LLM-INT] Additional info: ${additionalInfo ? additionalInfo.substring(0, 100) + "..." : "(none)"}`
  );

  // Determine if employee is active
  const isActive = employee.status && employee.status.toLowerCase().includes('aktywny') && !employee.status.toLowerCase().includes('nieaktywny');

  // Determine gender-specific instructions with tense consideration
  const genderNote = employee.gender === 'K'
    ? `WAŻNE: Ta osoba jest KOBIETĄ - używaj form żeńskich ${isActive ? '(np. "wykonuje", "angażuje się", "odnajduje się")' : '(np. "wykonywała", "angażowała się", "odnajdywała się")'}.`
    : employee.gender === 'M'
    ? `WAŻNE: Ta osoba jest MĘŻCZYZNĄ - używaj form męskich ${isActive ? '(np. "wykonuje", "angażuje się", "odnajduje się")' : '(np. "wykonywał", "angażował się", "odnajdywał się")'}.`
    : 'Dostosuj formy gramatyczne do płci na podstawie imienia.';

  const tenseNote = isActive
    ? 'UWAGA: Status tej osoby to AKTYWNY - używaj form TERAŹNIEJSZYCH czasowników we wszystkich sekcjach.'
    : 'UWAGA: Status tej osoby to NIEAKTYWNY - używaj form PRZESZŁYCH czasowników we wszystkich sekcjach.';

  // Get team description if available
  const teamDescription = getTeamDescriptionText(employee.team);

  const prompt = `Jesteś koordynatorem praktyk/stażu w organizacji pozarządowej LEVEL UP. Tworzysz profesjonalną ocenę praktyki/stażu.

Informacje o praktykantcie/stażyście:
- Imię i nazwisko: ${employee.name} ${employee.surname}
- Status: ${employee.status || 'nieznany'}
${genderNote}
${tenseNote}
- Data rozpoczęcia: ${employee.startDate}
- Data zakończenia: ${employee.endDate}
- Zespół: ${employee.team}
- Główne zadania: ${employee.mainTasks}

${teamDescription}

Dodatkowe informacje od koordynatora (dziennik praktyk, plan praktyk, obserwacje):
${additionalInfo}

INSTRUKCJE - WAŻNE:
Na podstawie powyższych informacji (w tym opisu działań zespołu) wygeneruj ocenę praktyki/stażu w formacie JSON.

UWAGA: Wykorzystuj informacje o głównych działaniach zespołu do precyzyjnego opisywania zadań praktykanta/stażysty.

1. "mainTasks" - Wypiszesz ZAWSZE dokładnie 4 główne zadania praktykanta/stażysty na podstawie informacji z dziennika lub planu praktyk. Każde zadanie jako osobne zdanie. Format: "1. Zadanie pierwsze. 2. Zadanie drugie. 3. Zadanie trzecie. 4. Zadanie czwarte."

2. "internshipDescription" - Opis praktyk: DOKŁADNIE 4 zdania. Ogólne informacje o działaniach praktykanta/stażysty podczas praktyki.

3. "generalInformation" - Ogólne informacje o działaniach: DOKŁADNIE 4 zdania. Szczegółowy opis aktywności i zaangażowania.

4. "evaluation" - Ocena: DOKŁADNIE 4 zdania. Napisz ocenę działań, w jakich zadaniach najlepiej się odnajdywał/odnajdywała (dostosuj do płci). Bądź konkretny i profesjonalny.

5. "grade" - Ocena końcowa: np. "Bardzo dobra", "Dobra", "Zadowalająca", "Celująca"

ZASADY:
- Pisz w trzeciej osobie po polsku
- Używaj TYLKO informacji, które zostały podane
- Bądź konkretny i profesjonalny
- Każda sekcja musi mieć DOKŁADNIE określoną liczbę zdań
- Nie dodawaj ani nie zmniejszaj liczby zdań
- OBOWIĄZKOWO dostosuj wszystkie formy gramatyczne czasowników i przymiotników do płci osoby

Zwróć TYLKO poprawny JSON w formacie:
{
  "mainTasks": "1. Zadanie pierwsze. 2. Zadanie drugie. 3. Zadanie trzecie. 4. Zadanie czwarte.",
  "internshipDescription": "Zdanie 1. Zdanie 2. Zdanie 3. Zdanie 4.",
  "generalInformation": "Zdanie 1. Zdanie 2. Zdanie 3. Zdanie 4.",
  "evaluation": "Zdanie 1. Zdanie 2. Zdanie 3. Zdanie 4.",
  "grade": "Bardzo dobra"
}`;

  try {
    console.log("[LLM-INT] Calling Ollama API...");
    let response = await generate(prompt);

    console.log("[LLM-INT] Parsing JSON response...");

    // Clean up the response - extract only the first valid JSON object
    let cleanedResponse = response.trim();

    // Find the start of the first JSON object
    const startIdx = cleanedResponse.indexOf('{');
    if (startIdx === -1) {
      throw new Error('No JSON object found in response');
    }

    // Use brace counting to find the matching closing brace for the FIRST object only
    let depth = 0;
    let inString = false;
    let escaped = false;
    let endIdx = -1;

    for (let i = startIdx; i < cleanedResponse.length; i++) {
      const char = cleanedResponse[i];

      // Handle escape sequences
      if (escaped) {
        escaped = false;
        continue;
      }

      if (char === '\\') {
        escaped = true;
        continue;
      }

      // Track string boundaries (don't count braces inside strings)
      if (char === '"') {
        inString = !inString;
      }

      // Count braces only outside of strings
      if (!inString) {
        if (char === '{') {
          depth++;
        } else if (char === '}') {
          depth--;
          // When we return to depth 0, we've found the end of the first object
          if (depth === 0) {
            endIdx = i + 1;
            break;
          }
        }
      }
    }

    if (endIdx === -1) {
      console.log("[LLM-INT] WARNING: Could not find matching closing brace");
      throw new Error('Incomplete JSON object in response');
    }

    // Extract only the first complete JSON object
    cleanedResponse = cleanedResponse.substring(startIdx, endIdx);
    console.log("[LLM-INT] Extracted first JSON object");
    console.log(`[LLM-INT] Length: ${cleanedResponse.length} chars`);

    // Remove trailing comma before closing brace (LLM sometimes adds it)
    cleanedResponse = cleanedResponse.replace(/,(\s*})$/, '$1');

    const parsed = JSON.parse(cleanedResponse);

    console.log("[LLM-INT] ✓ Parsed successfully");

    const result = {
      name: employee.name,
      surname: employee.surname,
      startDate: employee.startDate,
      endDate: employee.endDate,
      team: employee.team,
      mainTasks: parsed.mainTasks || "",
      internshipDescription: parsed.internshipDescription || "",
      generalInformation: parsed.generalInformation || "",
      evaluation: parsed.evaluation || "",
      grade: parsed.grade || "Dobra",
    };

    console.log("[LLM-INT] Generated fields:");
    console.log(
      `[LLM-INT]   - mainTasks: ${result.mainTasks ? result.mainTasks.length + " chars" : "(empty)"}`
    );
    console.log(
      `[LLM-INT]   - internshipDescription: ${result.internshipDescription ? result.internshipDescription.length + " chars" : "(empty)"}`
    );
    console.log(
      `[LLM-INT]   - generalInformation: ${result.generalInformation ? result.generalInformation.length + " chars" : "(empty)"}`
    );
    console.log(
      `[LLM-INT]   - evaluation: ${result.evaluation ? result.evaluation.length + " chars" : "(empty)"}`
    );
    console.log(`[LLM-INT]   - grade: ${result.grade}`);

    return result;
  } catch (error) {
    console.log("[LLM-INT] ✗ Generation failed, using defaults");
    console.log(`[LLM-INT] Error: ${error.message}`);

    return {
      name: employee.name,
      surname: employee.surname,
      startDate: employee.startDate,
      endDate: employee.endDate,
      team: employee.team,
      mainTasks: "",
      internshipDescription: "",
      generalInformation: "",
      evaluation: "",
      grade: "Dobra",
    };
  }
}

/**
 * Generate content based on task type
 * @param {string} task - Task type
 * @param {object} employee - Employee data
 * @param {string} additionalInfo - Additional information
 * @returns {Promise<object>} - Generated content
 */
export async function generateContent(task, employee, additionalInfo) {
  const generators = {
    [TaskType.REFERENCES]: generateReferences,
    [TaskType.CERT]: generateCert,
    [TaskType.INTERNSHIP]: generateInternship,
  };

  const generator = generators[task];
  if (!generator) {
    throw new Error(`Unknown task type: ${task}`);
  }

  return generator(employee, additionalInfo);
}

export default {
  generateReferences,
  generateCert,
  generateInternship,
  generateContent,
};
